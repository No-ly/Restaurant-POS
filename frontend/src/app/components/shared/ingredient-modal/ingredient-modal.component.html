<div class="modal-backdrop" [class.show]="isVisible" (click)="closeModal()">
  <div class="modal-container glass-panel" (click)="preventClose($event)">

    <!-- Header -->
    <div class="modal-header">
      <h3 class="modal-title text-gradient">Personalizar {{ product?.nombre }}</h3>
      <button class="btn-close" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="modal-loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2">Cargando ingredientes...</p>
    </div>

    <!-- Contenido cuando NO está cargando -->
    <div *ngIf="!loading" class="modal-content">

      <!-- Caso 1: Producto SIN ingredientes personalizables -->
      <div *ngIf="ingredientes.length === 0" class="no-ingredients">
        <i class="fas fa-info-circle fa-3x mb-3 text-muted"></i>
        <h5 class="text-secondary">Sin opciones de personalización</h5>
        <p class="text-muted mb-4">Este producto no tiene ingredientes que se puedan modificar.</p>
        <button class="btn btn-primary btn-lg" (click)="addWithoutCustomization()">
          <i class="fas fa-check me-2"></i>
          Agregar al Pedido
        </button>
      </div>

      <!-- Caso 2: Producto CON ingredientes personalizables -->
      <div *ngIf="ingredientes.length > 0">

        <!-- Lista de Ingredientes -->
        <div class="ingredients-list">
          <div
            *ngFor="let ing of ingredientes"
            class="ingredient-item"
            [class.non-modifiable]="!ing.es_modificable"
          >
            <label class="ingredient-label">
              <input
                type="checkbox"
                [checked]="ing.seleccionado"
                [disabled]="!ing.es_modificable"
                (change)="toggleIngredient(ing)"
                class="ingredient-checkbox"
              >
              <span class="ingredient-name">{{ ing.nombre }}</span>
              <span *ngIf="ing.precio_extra > 0" class="ingredient-price">
                +${{ ing.precio_extra }}
              </span>
              <span *ngIf="!ing.es_modificable" class="ingredient-badge">
                Obligatorio
              </span>
            </label>
            <div class="ingredient-description">
              <small class="text-muted">
                {{ ing.es_default ? 'Incluido por defecto' : 'Opcional' }}
              </small>
            </div>
          </div>
        </div>

        <!-- Resumen de Especificaciones -->
        <div *ngIf="generateEspecificaciones()" class="especificaciones-summary">
          <h5>Tu pedido será:</h5>
          <p class="especificaciones-text">{{ generateEspecificaciones() }}</p>
        </div>

      </div>

    </div>

    <!-- Footer solo para productos CON ingredientes -->
    <div class="modal-footer" *ngIf="!loading && ingredientes.length > 0">
      <button class="btn btn-secondary" (click)="closeModal()">
        Cancelar
      </button>
      <button
        class="btn btn-primary"
        (click)="confirmSelection()"
        [disabled]="loading"
      >
        <i class="fas fa-check me-2"></i>
        Agregar al Pedido
      </button>
    </div>

  </div>
</div>
